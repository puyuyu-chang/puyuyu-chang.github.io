// 変数
let puyuyu = 0;
let clickPower = 1;   // クリックで増える数
let tapLevel = 1;     // タップのレベル
let tapCost = 50;     // タップの初期コスト

// 🥺クリック時
canvas.addEventListener("click", (e) => {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  const clickX = (e.clientX - rect.left) * scaleX;
  const clickY = (e.clientY - rect.top) * scaleY;

  // 🥺本体クリック判定
  if (
    clickX >= x - emojiRadius &&
    clickX <= x + emojiRadius &&
    clickY >= y - emojiRadius &&
    clickY <= y + emojiRadius
  ) {
    const angle = newDirection();
    const speed = 2.0;
    dx = Math.cos(angle) * speed;
    dy = Math.sin(angle) * speed;
    puyuyu += clickPower;  // ← 強化された数値で加算
  }

  // タップ購入判定（右下のボタン領域を簡単に矩形で定義）
  const tapX = canvas.width - 150; // ボタンの左上X
  const tapY = canvas.height - 40; // ボタンの左上Y
  const tapW = 140;                // ボタン幅
  const tapH = 30;                 // ボタン高さ

  if (
    clickX >= tapX &&
    clickX <= tapX + tapW &&
    clickY >= tapY &&
    clickY <= tapY + tapH
  ) {
    if (puyuyu >= tapCost) {
      puyuyu -= tapCost;
      tapLevel++;
      clickPower = Math.floor(1 + clickPower * 0.1);
      tapCost += Math.floor(tapCost * 0.1);
    }
  }
});

function update() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // 🥺移動とバウンド
  x += dx;
  y += dy;

  if (x - emojiRadius <= 0 || x + emojiRadius >= canvas.width) {
    dx = -dx;
    x = Math.max(emojiRadius, Math.min(x, canvas.width - emojiRadius));
  }
  if (y - emojiRadius <= 0 || y + emojiRadius >= canvas.height) {
    dy = -dy;
    y = Math.max(emojiRadius, Math.min(y, canvas.height - emojiRadius));
  }

  // 🥺描画
  ctx.save();
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.font = fontSize + "px serif";
  ctx.fillText(emoji, x, y);
  ctx.restore();

  // カウンター（左上）
  ctx.save();
  ctx.textAlign = "left";
  ctx.textBaseline = "top";
  ctx.font = "20px sans-serif";  // ← フォントサイズ変更
  ctx.fillText("🥺 " + puyuyu, 8, 8);
  ctx.restore();

  // タップ購入ボタン（右下）
  ctx.save();
  ctx.textAlign = "right";
  ctx.textBaseline = "bottom";
  ctx.font = "18px sans-serif";
  ctx.fillText("タップ(Lv" + tapLevel + ") 🥺" + tapCost, canvas.width - 10, canvas.height - 10);
  ctx.restore();

  requestAnimationFrame(update);
}
