<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ¥ºãƒã‚¦ãƒ³ãƒ‰ï¼ˆå½“ãŸã‚Šåˆ¤å®šä¿®æ­£ï¼‰</title>
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start; /* ä¸Šå¯„ã› */
      height: 100vh;
      margin: 0;
      background: #ffffdd;
    }
    canvas {
      border: 6px solid black; /* æ å¤ªã•6px */
      margin-top: 40px;
      image-rendering: auto; /* ã‚¢ãƒ³ãƒã‚¨ã‚¤ãƒªã‚¢ã‚¹å„ªå…ˆ */
    }
  </style>
</head>
<body>
  <canvas id="game" width="450" height="450"></canvas>

  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const emoji = "ğŸ¥º";
    const fontSize = 90; // ãƒ¡ã‚¤ãƒ³çµµæ–‡å­—ã‚µã‚¤ã‚º
    ctx.fillStyle = "#000"; // æç”»è‰²

    // puyuyu ã‚«ã‚¦ãƒ³ãƒˆ
    let puyuyu = 0;

    // ä½ç½®ãƒ»é€Ÿåº¦
    let x = canvas.width / 2;
    let y = canvas.height / 2;
    let dx = 0;
    let dy = 0;
    let lastAngle = null;

    // çµµæ–‡å­—ã®æç”»çŸ©å½¢ï¼ˆå¹…/é«˜ã•ï¼‰ã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function measureEmoji() {
      ctx.font = `${fontSize}px serif`;
      const m = ctx.measureText(emoji);

      const width = m.width || fontSize; // å¹…ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚ã‚Šï¼‰
      // é«˜ã•ã¯ actualBoundingBox ãŒã‚ã‚Œã°ä½¿ã„ã€ãªã‘ã‚Œã° fontSize ã‚’ä½¿ã†
      const height = (typeof m.actualBoundingBoxAscent === "number" && typeof m.actualBoundingBoxDescent === "number")
        ? (m.actualBoundingBoxAscent + m.actualBoundingBoxDescent)
        : fontSize;

      return { width, height };
    }

    // æœ€åˆã«è¨ˆæ¸¬
    let metrics = measureEmoji();
    let halfW = metrics.width / 2;
    let halfH = metrics.height / 2;

    // è§’åº¦ç”Ÿæˆï¼ˆå‰å›ã¨ä¼¼ã™ããªã„ï¼š60åº¦ä»¥ä¸Šé•ã†ã‚‚ã®ã‚’é¸ã¶ï¼‰
    function newDirection() {
      let angle;
      do {
        angle = Math.random() * 2 * Math.PI;
      } while (
        lastAngle !== null &&
        Math.abs(Math.atan2(Math.sin(angle - lastAngle), Math.cos(angle - lastAngle))) < (Math.PI / 3)
      );
      lastAngle = angle;
      return angle;
    }

    // ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹åº§æ¨™ã§åˆ¤å®šï¼‰
    canvas.addEventListener("click", (e) => {
      const rect = canvas.getBoundingClientRect();
      const clickX = e.clientX - rect.left;
      const clickY = e.clientY - rect.top;

      // å†è¨ˆæ¸¬ï¼ˆç’°å¢ƒã«ã‚ˆã£ã¦æœ€åˆã®è¨ˆæ¸¬ã¨å·®ãŒå‡ºã‚‹å ´åˆãŒã‚ã‚‹ãŸã‚å®‰å…¨ç­–ï¼‰
      metrics = measureEmoji();
      halfW = metrics.width / 2;
      halfH = metrics.height / 2;

      // æç”»æ™‚ã¯ (x,y) ã‚’ä¸­å¿ƒã«ã—ã¦å·¦ä¸Šåº§æ¨™ã‚’æ±ºå®šã—ã¦ã„ã‚‹ã®ã§ãã‚Œã‚’ä½¿ã£ã¦çŸ©å½¢åˆ¤å®š
      const drawX = x - halfW;
      const drawY = y - halfH;

      if (
        clickX >= drawX &&
        clickX <= drawX + metrics.width &&
        clickY >= drawY &&
        clickY <= drawY + metrics.height
      ) {
        // å½“ãŸã‚Šï¼šæ–¹å‘ã‚’å¤‰ãˆã€é€Ÿåº¦ã‚’è¨­å®šã€puyuyu ã‚’ +1
        const angle = newDirection();
        const speed = 2.0;
        dx = Math.cos(angle) * speed;
        dy = Math.sin(angle) * speed;
        puyuyu++;
      }
    });

    // ãƒ«ãƒ¼ãƒ—
    function update() {
      // ä½ç½®æ›´æ–°
      x += dx;
      y += dy;

      // å†è¨ˆæ¸¬ï¼ˆå¿µã®ãŸã‚ãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã«è¨ˆæ¸¬ã—ã¦å¹…é«˜ã•ã‚’æœ€æ–°ã«ï¼‰
      metrics = measureEmoji();
      halfW = metrics.width / 2;
      halfH = metrics.height / 2;

      // å£åå°„ï¼ˆçŸ©å½¢ã®ç«¯ãŒã‚­ãƒ£ãƒ³ãƒã‚¹å¤–ã«å‡ºãªã„ã‚ˆã†ã«ï¼‰
      if (x - halfW <= 0) {
        dx = -dx;
        x = halfW;
      } else if (x + halfW >= canvas.width) {
        dx = -dx;
        x = canvas.width - halfW;
      }
      if (y - halfH <= 0) {
        dy = -dy;
        y = halfH;
      } else if (y + halfH >= canvas.height) {
        dy = -dy;
        y = canvas.height - halfH;
      }

      // æç”»
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // ãƒ¡ã‚¤ãƒ³çµµæ–‡å­—ï¼ˆå·¦ä¸ŠåŸºæº–ã§æç”»ã™ã‚‹ãŸã‚ drawX/drawY ã‚’è¨ˆç®—ï¼‰
      ctx.font = `${fontSize}px serif`;
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      const drawX = x - halfW;
      const drawY = y - halfH;
      ctx.fillText(emoji, drawX, drawY);

      // å·¦ä¸Šã«å°ã•ã "ğŸ¥º <æ•°å€¤>" ã‚’è¡¨ç¤ºï¼ˆ"puyuyu:" éƒ¨åˆ†ã¯è¡¨ç¤ºã—ãªã„ï¼‰
      ctx.font = "16px sans-serif";
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      ctx.fillText("ğŸ¥º " + puyuyu, 8, 8);

      requestAnimationFrame(update);
    }

    // é–‹å§‹
    update();
  </script>
</body>
</html>
